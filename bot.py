import os
import telebot
from google import genai
from google.genai.errors import APIError

# -------------------------------------------------------------
# 1. ุงูุฅุนุฏุงุฏุงุช ูุงูุชููุฆุงุช
# -------------------------------------------------------------

# ุงูุชููู ุงูุฎุงุต ุจุจูุช ุชูููุฌุฑุงู (ูุถูููู ูุจุงุดุฑุฉ ุฃู ููุถู ูุถุนู ููุชุบูุฑ ุจูุฆุฉ)
BOT_TOKEN = '6807502954:AAH5tOwXCjRXtF65wQFEDSkYeFBYIgUjblg' 

# ููุชุงุญ API ุงูุฎุงุต ุจู Gemini. 
# ูุฌุจ ุงูุญุตูู ุนููู ูู Google AI Studio ููุถุนู ููุชุบูุฑ ุจูุฆุฉ ุนูู Railway.
# ุนูุฏ ุงูุชุดุบูู ูุญูููุงุ ููููู ุชุนูููู ูุจุงุดุฑุฉ ุฃู ุนุจุฑ ูุชุบูุฑ ุจูุฆุฉ.
# ุณูููู ุจุงูุชุญููู ุงูุชููุงุฆู ูู ูุชุบูุฑ ุงูุจูุฆุฉ 'GEMINI_API_KEY'
GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY")

if not BOT_TOKEN:
    print("โ ุฎุทุฃ ูุงุฏุญ: ุชููู ุชูููุฌุฑุงู ุบูุฑ ููุฌูุฏ.")
    exit(1)

if not GEMINI_API_KEY:
    print("โ ุฎุทุฃ ูุงุฏุญ: ููุชุงุญ GEMINI_API_KEY ุบูุฑ ููุฌูุฏ. ูู ูุนูู ุงูุจูุช ุจุฏูู ูุฐุง ุงูููุชุงุญ.")
    # ูุง ูุฎุฑุฌุ ููู ุณูุฑุณู ุฑุณุงูุฉ ุฎุทุฃ ุนูุฏ ูุญุงููุฉ ุงุณุชุฎุฏุงู ุงูุจูุช
    pass

bot = telebot.TeleBot(BOT_TOKEN)
client = None
if GEMINI_API_KEY:
    try:
        client = genai.Client(api_key=GEMINI_API_KEY)
        print("โ ุชู ุชููุฆุฉ ุนููู Gemini API ุจูุฌุงุญ.")
    except Exception as e:
        print(f"โ ูุดู ุชููุฆุฉ ุนููู Gemini: {e}")
        client = None

# ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงูุชู ุชููุฌู ูููุฐุฌ Gemini ูุฃุฏุงุก ูููุฉ ุงูุฅุนุฑุงุจ
SYSTEM_PROMPT = (
    "ุฃูุช ูุฏูู ูุบูู ููุนูู ูุญู ุนุฑุจู ูุฏูุฑ ููุชุฎุตุต ูู ุงูุฅุนุฑุงุจ. "
    "ูููุชู ูู ุฅุนุฑุงุจ ุงูุฌููุฉ ุงูุชู ูุฑุณููุง ุงููุณุชุฎุฏู ุฅุนุฑุงุจุงู ุชูุตูููุงู ูุดุงููุงู. "
    "ูุฌุจ ุฃู ูููู ุงูุฅุนุฑุงุจ ููุธูุงู ูู ุดูู ูุงุฆูุฉ ููุทูุฉ ูุงุถุญุฉ (Markdown), ููุฌุจ ุฃู ุชุณุชุฎุฏู ุงููุตุทูุญุงุช ุงููุญููุฉ ุงููุตุญู. "
    "ูุง ุชุถู ุฃู ููุฏูุงุช ุฃู ุฎุงุชูุงุช ููุฑุฏุ ููุท ุงุจุฏุฃ ุจุงูุฅุนุฑุงุจ ูุจุงุดุฑุฉู."
)

# -------------------------------------------------------------
# 2. ูุธููุฉ ูุนุงูุฌุฉ ุงูุฅุนุฑุงุจ
# -------------------------------------------------------------

def get_grammar_analysis(text):
    """
    ูุชูุงุตู ูุน Gemini API ูุทูุจ ุงูุฅุนุฑุงุจ ุงูุชูุตููู ูููุต.
    """
    if not client:
        return "โ ุนุฐุฑุงูุ ูู ูุชู ุฅุนุฏุงุฏ ููุชุงุญ Gemini API ุจุดูู ุตุญูุญ ุนูู ุงูุฎุงุฏู."

    try:
        # ุฅุฑุณุงู ุงููููุฉ ูุงูุชุนูููุงุช ุฅูู ุงููููุฐุฌ
        response = client.models.generate_content(
            model='gemini-2.5-flash', # ูููุฐุฌ ุณุฑูุน ูููุงุณุจ ููุฐู ุงููููุฉ
            contents=text,
            config={"system_instruction": SYSTEM_PROMPT}
        )
        return response.text
    except APIError as e:
        print(f"โ ุฎุทุฃ ูู Gemini API: {e}")
        return "โ ุนุฐุฑุงูุ ูุงุฌูุช ุฎุทุฃู ูู ุงูุงุชุตุงู ุจุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู. ูุฏ ุชููู ุงูุญุตุฉ ุงููุฌุงููุฉ ูุฏ ุงุณุชูููุฏุช."
    except Exception as e:
        print(f"โ ุฎุทุฃ ุนุงู: {e}")
        return "โ ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน ุฃุซูุงุก ูุนุงูุฌุฉ ุทูุจู."

# -------------------------------------------------------------
# 3. ูุธุงุฆู ุจูุช ุชูููุฌุฑุงู
# -------------------------------------------------------------

@bot.message_handler(commands=['start', 'help'])
def send_welcome(message):
    bot.reply_to(message, 
                 "๐ ูุฑุญุจุงู ุจู ูู ุจูุช ุงูุฅุนุฑุงุจ ุงูุฐูู!.\n"
                 "ุฃุฑุณู ูู ุฃู ุฌููุฉ ุนุฑุจูุฉ ูุณุฃููู ุจุฅุนุฑุงุจูุง ุฅุนุฑุงุจุงู ุชูุตูููุงู ูุดุงููุงู ูู.")

@bot.message_handler(content_types=['text'])
def handle_grammar_request(message):
    user_text = message.text
    
    if len(user_text) < 3 or len(user_text) > 500: 
        bot.reply_to(message, "โ๏ธ ูุฑุฌู ุฅุฑุณุงู ุฌููุฉ ุนุฑุจูุฉ ูุงุถุญุฉ ุชุชุฑุงูุญ ุจูู 3 ู 500 ุญุฑู.")
        return

    # ุฑุณุงูุฉ ุงูุงูุชุธุงุฑ
    status_message = bot.reply_to(message, "โณ ุฌุงุฑู ุชุญููู ุงูุฌููุฉ ูุญูููุง...")

    try:
        # ุงูุญุตูู ุนูู ุงูุฅุนุฑุงุจ ูู Gemini
        analysis_result = get_grammar_analysis(user_text)
        
        # ุฅุฑุณุงู ุงููุชูุฌุฉ
        bot.edit_message_text(analysis_result, status_message.chat.id, status_message.message_id, parse_mode='Markdown')

    except Exception as e:
        print(f"โ ุฎุทุฃ ุฃุซูุงุก ุงููุนุงูุฌุฉ: {e}")
        bot.edit_message_text("โ ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน.", status_message.chat.id, status_message.message_id)

# ุชุดุบูู ุงูุจูุช
if __name__ == '__main__':
    print("๐ ุจุฏุก ุชุดุบูู ุจูุช ุงูุฅุนุฑุงุจ...")
    try:
        bot.infinity_polling()
    except Exception as e:
        print(f"โ ูุดู ุชุดุบูู ุงูุจูุช: {e}")
